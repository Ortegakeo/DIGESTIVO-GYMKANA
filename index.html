<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Digestivo 3B Interactivo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --ucm-blue:#0078D7;
      --ucm-dark:#004e92;
      --ucm-gray:#f3f5f7;
      --ok:#19a974;
      --bad:#e11d48;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Arial, Helvetica, sans-serif; background:#fafafa; color:#222;
    }
    header{
      padding:14px 16px; background:linear-gradient(90deg, var(--ucm-dark), var(--ucm-blue));
      color:#fff; text-align:center;
    }
    h1{margin:0 0 8px 0; font-size:22px; letter-spacing:.3px}
    .toolbar{
      display:flex; flex-wrap:wrap; gap:8px; justify-content:center; align-items:center;
      padding:12px; background:#fff; border-bottom:1px solid #e5e7eb;
    }
    .toolbar select, .toolbar button{
      padding:8px 12px; border-radius:8px; border:1px solid #d1d5db; background:#fff; cursor:pointer;
      font-size:14px;
    }
    .toolbar button{
      background:var(--ucm-blue); color:#fff; border:none; box-shadow:0 1px 0 rgba(0,0,0,.08);
    }
    .toolbar button.secondary{ background:#fff; color:#111; border:1px solid #d1d5db; }
    .toolbar button:hover{ filter:brightness(.95); }
    .wrap{
      display:flex; flex-direction:column; align-items:center; gap:12px; padding:16px;
    }
    #container{
      position:relative; display:inline-block; max-width:1200px; width:95%;
      background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px;
      box-shadow:0 6px 24px rgba(0,0,0,.06);
    }
    #imgWrap{ position:relative; width:100%; }
    #torso{
      width:100%; height:auto; border-radius:8px; display:block; user-select:none;
    }
    .hotspot{
      position:absolute; width:32px; height:32px; border-radius:50%;
      background:rgba(255,0,0,.8); color:#fff; font-weight:700; font-size:14px;
      display:flex; align-items:center; justify-content:center; user-select:none;
      cursor:grab; transform:translate(-50%, -50%); transition:transform .15s ease, opacity .15s ease;
    }
    .hotspot:active{ cursor:grabbing; transform:translate(-50%, -50%) scale(1.05); }
    .invisible{ opacity:0; pointer-events:auto; } /* invisibles pero clickeables */
    .hidden{ display:none; }

    #infoBox{
      position:fixed; right:16px; bottom:16px; width:360px; max-width:92vw;
      background:#fff; border:2px solid var(--ucm-blue); border-radius:12px; padding:12px;
      font-weight:700; box-shadow:0 8px 30px rgba(0,0,0,.12);
    }
    #log{
      width:100%; max-width:1200px; background:#fff; border:1px solid #e5e7eb;
      border-radius:12px; overflow:auto;
    }
    table{ width:100%; border-collapse:collapse; font-size:14px; }
    th, td{ border-bottom:1px solid #eef2f7; padding:8px 10px; text-align:left; }
    th{ background:var(--ucm-gray); }
    .tag{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; }
    .ok{ background:#e8fff5; color:var(--ok); border:1px solid #b5f2d7; }
    .bad{ background:#ffeaf0; color:var(--bad); border:1px solid #ffc0d1; }
    .muted{ color:#6b7280; font-weight:400; }
    .note{ font-size:12px; color:#6b7280; }
    .flex-gap{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
    input[type="file"]{ display:none; }
    @media (max-width:768px){
      #infoBox{ position:static; width:calc(100% - 32px); margin:0 16px 16px; }
      header{ text-align:center; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Modelo 3B Interactivo ‚Äì Aparato Digestivo</h1>
    <div class="note">Planas separadas, numeraci√≥n propia por imagen. Edita posiciones una vez y quedan guardadas.</div>
  </header>

  <div class="toolbar">
    <label>Plana:&nbsp;
      <select id="planaSel">
        <option value="ABDOMEN.jpg">ü´Ä H√≠gado / Abdomen</option>
        <option value="estomago.jpg">üçΩÔ∏è Est√≥mago</option>
        <option value="INTESTINOS.jpg">üß´ Intestinos</option>
      </select>
    </label>

    <div class="flex-gap">
      <button id="modoEdicion">Modo Edici√≥n</button>
      <button class="secondary" id="modoConsulta">Modo Consulta</button>
      <button class="secondary" id="modoPractica">Modo Pr√°ctica</button>
    </div>

    <div class="flex-gap">
      <button class="secondary" id="exportBtn">Exportar posiciones</button>
      <label for="importFile" class="secondary" style="padding:8px 12px;">Importar posiciones</label>
      <input type="file" id="importFile" accept="application/json" />
      <button class="secondary" id="resetBtn">Reset locales</button>
    </div>
  </div>

  <div class="wrap">
    <div id="container">
      <div id="imgWrap">
        <img id="torso" src="ABDOMEN.jpg" alt="ABDOMEN (H√≠gado)">
        <!-- hotspots se inyectan por JS -->
      </div>
    </div>

    <div id="infoBox">Modo: <span id="modeLabel">Edici√≥n</span> ‚Äî haz clic en un n√∫mero (o arr√°stralo en Edici√≥n).</div>

    <div id="log">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Tu respuesta</th>
            <th>Correcto</th>
            <th>Resultado</th>
            <th>Plana</th>
          </tr>
        </thead>
        <tbody id="tbodyLog"></tbody>
      </table>
    </div>
  </div>

  <script>
    // --------- Datos por plana (s√≥lo sus propios n√∫meros) ----------
    // ABDOMEN.jpg ‚Üí H√≠gado (1‚Äì28)
    const nombres_ABDOMEN = {
      1:"H√≠gado",
      2:"H√≠gado, √°rea desnuda",
      3:"H√≠gado, cara diafragm√°tica",
      4:"H√≠gado, cara visceral",
      5:"H√≠gado, impresi√≥n del colon",
      6:"H√≠gado, impresi√≥n del duodeno",
      7:"H√≠gado, impresi√≥n del est√≥mago",
      8:"H√≠gado, impresi√≥n del es√≥fago",
      9:"H√≠gado, impresi√≥n del ri√±√≥n",
      10:"H√≠gado, l√≥bulo caudado",
      11:"H√≠gado, l√≥bulo derecho",
      12:"H√≠gado, l√≥bulo cuadrado",
      13:"H√≠gado, l√≥bulo izquierdo",
      14:"H√≠gado, borde inferior",
      15:"H√≠gado, proceso caudado",
      16:"Arteria hep√°tica com√∫n",
      17:"Conducto hep√°tico derecho",
      18:"Conducto hep√°tico izquierdo",
      19:"Vena cava inferior",
      20:"Venas hep√°ticas",
      21:"Ligamento redondo del h√≠gado",
      22:"Ligamento falciforme",
      23:"Ves√≠cula biliar, cuello",
      24:"Ves√≠cula biliar, cuerpo",
      25:"Ves√≠cula biliar, fondo",
      26:"Conducto c√≠stico",
      27:"Conducto col√©doco",
      28:"Vena porta hep√°tica"
    };

    // estomago.jpg ‚Üí Est√≥mago (1‚Äì15)
    const nombres_ESTOMAGO = {
      1:"Arteria g√°strica derecha",
      2:"Arteria g√°strica izquierda",
      3:"Arterias g√°stricas cortas",
      4:"Arteria gastroepiploica derecha",
      5:"Arteria gastroepiploica izquierda",
      6:"Omento (epipl√≥n) mayor",
      7:"Est√≥mago, curvatura mayor",
      8:"Est√≥mago, curvatura menor",
      9:"Est√≥mago, escotadura angular",
      10:"Est√≥mago, escotadura card√≠aca",
      11:"Est√≥mago, cardias",
      12:"Est√≥mago, cuerpo",
      13:"Est√≥mago, fundus",
      14:"Es√≥fago, porci√≥n abdominal",
      15:"P√≠loro"
    };

    // INTESTINOS.jpg ‚Üí Intestino delgado y grueso (1‚Äì35)
    const nombres_INTESTINOS = {
      1:"Conducto pancre√°tico",
      2:"Colon ascendente",
      3:"Colon descendente",
      4:"Colon sigmoide",
      5:"Colon transverso",
      6:"Colon, haustra",
      7:"V√°lvula del orificio ileocecal",
      8:"V√°lvula ileocecal",
      9:"P√°ncreas, cabeza",
      10:"P√°ncreas, cola",
      11:"P√°ncreas, cuerpo",
      12:"P√°ncreas",
      13:"Duodeno",
      14:"Duodeno, √°ngulo inferior",
      15:"Duodeno, √°ngulo superior",
      16:"Duodeno, porci√≥n ascendente",
      17:"Duodeno, porci√≥n descendente",
      18:"Conducto col√©doco",
      19:"A. y v. espl√©nicas (lienales)",
      20:"Ap√©ndice vermiforme",
      21:"Ap√©ndice vermiforme, orificio",
      22:"Ciego",
      23:"Tenia libre",
      24:"√çleon",
      25:"Yeyuno",
      26:"Conducto pancre√°tico accesorio (Santorini)",
      27:"A. y v. mesent√©ricas superiores",
      28:"A. y v. mesent√©ricas inferiores",
      29:"Aa. y Vv. yeyunales e √≠leales",
      30:"A. y V. c√≥lica derecha",
      31:"A. y V. c√≥lica media",
      32:"A. y V. c√≥lica izquierda",
      33:"Aa. y Vv. sigmoideas",
      34:"A. rectal superior",
      35:"Mesocolon transverso"
    };

    // --------- Coordenadas iniciales aproximadas (en %) ----------
    // Generadas como columnas izquierda/derecha distribuidas verticalmente; af√≠nalas en Modo Edici√≥n.
    function gridCoords(count, cols = 2){
      const coords = [];
      const rows = Math.ceil(count / cols);
      for(let i=0;i<count;i++){
        const r = i % rows;
        const c = Math.floor(i / rows);
        const top = 6 + (r * (88 / Math.max(rows-1,1))); // 6% a 94%
        const left = c===0 ? 8 : (c===1 ? 92 : 50);
        coords.push({top, left});
      }
      return coords;
    }
    const coords_ABDOMEN   = gridCoords(28);
    const coords_ESTOMAGO  = gridCoords(15);
    const coords_INTESTINOS= gridCoords(35);

    // --------- Estado / elementos UI ----------
    const planaSel = document.getElementById('planaSel');
    const img = document.getElementById('torso');
    const imgWrap = document.getElementById('imgWrap');
    const modeLabel = document.getElementById('modeLabel');
    const tbodyLog = document.getElementById('tbodyLog');
    let modo = 'edicion'; // 'edicion' | 'consulta' | 'practica'
    let activos = [];      // hotspots activos
    let draggingHS = null;

    // Normalizaci√≥n para comparar
    function norm(s){
      return (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[.,;:]/g,' ').replace(/\s+/g,' ').trim();
    }

    // Obtiene mapa de nombres por plana
    function getNombres(){
      const src = planaSel.value;
      if(src==='ABDOMEN.jpg')  return nombres_ABDOMEN;
      if(src==='estomago.jpg') return nombres_ESTOMAGO;
      return nombres_INTESTINOS;
    }
    function getCoords(){
      const src = planaSel.value;
      if(src==='ABDOMEN.jpg')  return coords_ABDOMEN;
      if(src==='estomago.jpg') return coords_ESTOMAGO;
      return coords_INTESTINOS;
    }
    function keyFor(num){ return `${planaSel.value}__${num}`; }

    // Crea/recarga hotspots de la plana
    function renderPlana(){
      // limpiar anteriores
      activos.forEach(h=>h.remove());
      activos = [];
      // set imagen
      img.src = planaSel.value;
      img.alt = planaSel.options[planaSel.selectedIndex].text;

      const nombres = getNombres();
      const coords  = getCoords();

      // construir
      const nums = Object.keys(nombres).map(n=>parseInt(n,10)).sort((a,b)=>a-b);
      nums.forEach((num, idx)=>{
        const hs = document.createElement('div');
        hs.className = 'hotspot';
        hs.dataset.num = String(num);
        hs.textContent = num;

        // posici√≥n guardada o aproximada
        const saved = JSON.parse(localStorage.getItem(keyFor(num)) || 'null');
        const pos = saved || coords[idx] || {top: 10 + idx*2, left: (idx%2?92:8)};
        setHSPosition(hs, pos.top, pos.left);

        // visibilidad seg√∫n modo
        applyVisibility(hs);

        // eventos
        hs.addEventListener('mousedown', e=>{
          if(modo!=='edicion') return;
          draggingHS = {el:hs, startX:e.clientX, startY:e.clientY};
          e.preventDefault();
        });
        hs.addEventListener('click', ()=>{
          const correcto = nombres[num];
          if(modo==='consulta'){
            info(`${num}: ${correcto}`);
          }else if(modo==='practica'){
            const r = prompt(`Introduce el nombre para el n√∫mero ${num}:`);
            if(r==null) return;
            const ok = norm(r)===norm(correcto);
            pushLog(num, r, correcto, ok, planaSel.value);
            alert(ok ? `‚úÖ Correcto (${correcto})` : `‚ùå Incorrecto. Correcto: ${correcto}`);
          }
        });

        imgWrap.appendChild(hs);
        activos.push(hs);
      });
    }

    function setHSPosition(hs, topPct, leftPct){
      hs.style.top  = `${topPct}%`;
      hs.style.left = `${leftPct}%`;
    }

    // drag & drop en edici√≥n
    document.addEventListener('mousemove', e=>{
      if(!draggingHS) return;
      const rect = img.getBoundingClientRect();
      const x = ((e.clientX - rect.left) / rect.width) * 100;
      const y = ((e.clientY - rect.top)  / rect.height)* 100;
      setHSPosition(draggingHS.el, Math.max(0,Math.min(100,y)), Math.max(0,Math.min(100,x)));
    });
    document.addEventListener('mouseup', ()=>{
      if(!draggingHS) return;
      const hs = draggingHS.el;
      draggingHS = null;
      // guardar
      const num = hs.dataset.num;
      localStorage.setItem(keyFor(num), JSON.stringify({
        top: parseFloat(hs.style.top),
        left: parseFloat(hs.style.left)
      }));
    });

    // modos
    function setModo(m){
      modo = m;
      modeLabel.textContent = (m==='edicion'?'Edici√≥n':(m==='consulta'?'Consulta':'Pr√°ctica'));
      activos.forEach(applyVisibility);
      info(`Modo: ${modeLabel.textContent}. ${m==='edicion' ? 'Arrastra para ubicar y se guarda solo.' : 'Los puntos est√°n invisibles; haz clic para interactuar.'}`);
    }
    function applyVisibility(hs){
      if(modo==='edicion'){
        hs.classList.remove('invisible');
      }else{
        hs.classList.add('invisible'); // invisibles pero siguen clickeables
      }
    }

    // info/log
    function info(text){ document.getElementById('infoBox').textContent = text; }
    function pushLog(num, resp, corr, ok, plana){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><strong>${num}</strong></td>
        <td>${resp||'<span class="muted">‚Äî</span>'}</td>
        <td>${corr}</td>
        <td>${ok?'<span class="tag ok">Correcto</span>':'<span class="tag bad">Incorrecto</span>'}</td>
        <td class="muted">${plana}</td>
      `;
      tbodyLog.prepend(tr);
    }

    // export/import
    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const nombres = getNombres();
      const out = {plana:planaSel.value, posiciones:{}};
      Object.keys(nombres).forEach(n=>{
        const hs = activos.find(h=>h.dataset.num===String(n));
        if(!hs) return;
        out.posiciones[n] = {top: parseFloat(hs.style.top), left: parseFloat(hs.style.left)};
      });
      const blob = new Blob([JSON.stringify(out, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `${planaSel.value.replace(/\.[a-z]+$/i,'')}_posiciones.json`;
      a.click(); URL.revokeObjectURL(url);
    });

    document.getElementById('importFile').addEventListener('change', e=>{
      const file = e.target.files[0]; if(!file) return;
      const fr = new FileReader();
      fr.onload = ()=>{
        try{
          const data = JSON.parse(fr.result);
          if(!data || data.plana!==planaSel.value || !data.posiciones) throw new Error('Archivo incompatible con la plana actual.');
          Object.entries(data.posiciones).forEach(([n, pos])=>{
            localStorage.setItem(`${planaSel.value}__${n}`, JSON.stringify(pos));
          });
          renderPlana();
          alert('‚úÖ Posiciones importadas.');
        }catch(err){
          alert('‚ùå Error al importar: ' + err.message);
        }
      };
      fr.readAsText(file);
      e.target.value = '';
    });

    document.getElementById('resetBtn').addEventListener('click', ()=>{
      if(!confirm('¬øBorrar posiciones guardadas de la plana actual?')) return;
      const nombres = getNombres();
      Object.keys(nombres).forEach(n=> localStorage.removeItem(`${planaSel.value}__${n}`));
      renderPlana();
      alert('üîÑ Posiciones locales reiniciadas para esta plana.');
    });

    // listeners UI
    document.getElementById('modoEdicion').addEventListener('click', ()=> setModo('edicion'));
    document.getElementById('modoConsulta').addEventListener('click', ()=> setModo('consulta'));
    document.getElementById('modoPractica').addEventListener('click', ()=> setModo('practica'));
    planaSel.addEventListener('change', ()=> renderPlana());

    // init
    renderPlana();
    setModo('edicion');
  </script>
</body>
</html>
